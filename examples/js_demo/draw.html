<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Geo Tools - å®Œæ•´ç»˜åˆ¶æ¼”ç¤º</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 600px;
            margin-top: 20px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .toolbar {
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        .toolbar-group {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ccc;
        }
        .toolbar-group:last-child {
            border-bottom: none;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 120px;
        }
        button:hover {
            background: #005fa3;
        }
        button.active {
            background: #ff6b6b;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #log {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 400px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #e6f7ff;
            border-left: 4px solid #007acc;
            border-radius: 4px;
        }
        .feature-list {
            margin-top: 10px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .feature-item {
            padding: 8px;
            margin: 5px 0;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 3px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .feature-actions button {
            padding: 3px 8px;
            font-size: 11px;
            margin-left: 5px;
            min-width: auto;
        }
    </style>
</head>
<body>
    <h1>Leaflet Geo Tools - å®Œæ•´ç»˜åˆ¶æ¼”ç¤º</h1>
    
    <div class="status" id="status">çŠ¶æ€: å‡†å¤‡å°±ç»ª</div>
    
    <div class="toolbar">
        <div class="toolbar-group">
            <h3>ğŸ“ ç»˜åˆ¶å·¥å…·</h3>
            <button id="drawMarker">ğŸ“ ç‚¹ (Marker)</button>
            <button id="drawPolyline">ğŸ“ çº¿ (Polyline)</button>
            <button id="drawPolygon">ğŸ”· å¤šè¾¹å½¢ (Polygon)</button>
            <button id="drawRectangle">â¬œ çŸ©å½¢ (Rectangle)</button>
            <button id="drawCircle">â­• åœ†å½¢ (Circle)</button>
        </div>
        
        <div class="toolbar-group">
            <h3>ğŸ› ï¸ æ“ä½œæ§åˆ¶</h3>
            <button id="stopDrawing" disabled>ğŸ›‘ åœæ­¢ç»˜åˆ¶</button>
            <button id="clearAll">ğŸ§¹ æ¸…é™¤æ‰€æœ‰</button>
            <button id="toggleView">ğŸ—ºï¸ å±…ä¸­æ˜¾ç¤º</button>
        </div>
        
        <div class="toolbar-group">
            <h3>ğŸ’¾ æ•°æ®æ“ä½œ</h3>
            <button id="exportAll">ğŸ“‹ å¯¼å‡ºæ‰€æœ‰æ•°æ® (GeoJSON)</button>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="toolbar">
        <h4>å·²åˆ›å»ºè¦ç´ åˆ—è¡¨</h4>
        <div id="featureList" class="feature-list"></div>
    </div>
    
    <div id="log"></div>
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@7/turf.min.js"></script>
    
    <!-- ä½ çš„åº“ -->
    <script src="../../dist/index.js"></script>
    
    <script>
        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½æˆåŠŸ
        console.log('æ£€æŸ¥å…¨å±€å˜é‡:', window.LeafletGeoTools);
        
        // è·å–åº“çš„å¼•ç”¨
        const GeoTools = window.LeafletGeoTools;
        
        if (!GeoTools) {
            alert('é”™è¯¯: LeafletGeoTools åº“æœªåŠ è½½æˆåŠŸï¼è¯·æ£€æŸ¥ï¼š\n1. æ˜¯å¦æ­£ç¡®æ„å»ºäº† dist/index.js\n2. è·¯å¾„æ˜¯å¦æ­£ç¡®\n3. æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯ä¿¡æ¯');
            console.error('å¯ç”¨çš„å…¨å±€å˜é‡:', Object.keys(window));
        } else {
            console.log('åº“åŠ è½½æˆåŠŸï¼å¯ç”¨çš„ç±»:', Object.keys(GeoTools));
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        const map = L.map('map').setView([31.2304, 121.4737], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // çŠ¶æ€ç®¡ç†
        let currentEditor = null;
        const features = []; // å­˜å‚¨æ‰€æœ‰åˆ›å»ºçš„è¦ç´ å®ä¾‹
        let activeMode = null; // å½“å‰æ¿€æ´»çš„ç»˜åˆ¶æ¨¡å¼
        
        // DOM å…ƒç´ 
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const featureListEl = document.getElementById('featureList');
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ ' : type === 'success' ? 'âœ… ' : 'â„¹ï¸ ';
            logEl.innerHTML += `[${time}] ${prefix}${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(message) {
            statusEl.textContent = `çŠ¶æ€: ${message}`;
            log(message);
        }
        
        // æ›´æ–°è¦ç´ åˆ—è¡¨æ˜¾ç¤º
        function updateFeatureList() {
            featureListEl.innerHTML = '';
            features.forEach((feature, index) => {
                const item = document.createElement('div');
                item.className = 'feature-item';
                
                // è·å–è¦ç´ ç±»å‹
                let type = 'æœªçŸ¥';
                if (feature.constructor.name.includes('Marker')) type = 'ç‚¹';
                else if (feature.constructor.name.includes('Polyline')) type = 'çº¿';
                else if (feature.constructor.name.includes('Polygon')) type = 'å¤šè¾¹å½¢';
                else if (feature.constructor.name.includes('Rectangle')) type = 'çŸ©å½¢';
                else if (feature.constructor.name.includes('Circle')) type = 'åœ†å½¢';
                
                item.innerHTML = `
                    <span>${index + 1}. ${type}</span>
                    <div class="feature-actions">
                        <button onclick="viewFeature(${index})">æŸ¥çœ‹</button>
                        <button onclick="removeFeature(${index})">åˆ é™¤</button>
                    </div>
                `;
                featureListEl.appendChild(item);
            });
        }
        
        // å…¨å±€å‡½æ•° - æŸ¥çœ‹è¦ç´ 
        window.viewFeature = function(index) {
            if (features[index] && features[index].geojson) {
                try {
                    const geojson = features[index].geojson();
                    log(`æŸ¥çœ‹ ${features[index].constructor.name} ${index + 1}:`);
                    log(JSON.stringify(geojson, null, 2), 'info');
                    
                    // å®šä½åˆ°è¦ç´ 
                    if (geojson.geometry.type === 'Point') {
                        map.setView([geojson.geometry.coordinates[1], geojson.geometry.coordinates[0]], 16);
                    } else {
                        // å¯¹äºé¢å’Œçº¿ï¼Œè®¡ç®—è¾¹ç•Œ
                        const bounds = L.geoJSON(geojson).getBounds();
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                } catch (error) {
                    log(`è·å–è¦ç´ åæ ‡å¤±è´¥: ${error.message}`, 'error');
                }
            }
        };
        
        // å…¨å±€å‡½æ•° - åˆ é™¤è¦ç´ 
        window.removeFeature = function(index) {
            if (features[index]) {
                try {
                    if (features[index].destroy) features[index].destroy();
                    
                    features.splice(index, 1);
                    updateStatus(`å·²åˆ é™¤è¦ç´  ${index + 1}`);
                    updateFeatureList();
                } catch (error) {
                    log(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                }
            }
        };
        
        // ç¦ç”¨/å¯ç”¨æ‰€æœ‰ç»˜åˆ¶æŒ‰é’®
        function disableAllButtons(disabled) {
            ['drawMarker', 'drawPolyline', 'drawPolygon', 'drawRectangle', 'drawCircle']
                .forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = disabled;
                });
            
            document.getElementById('stopDrawing').disabled = !disabled;
        }
        
        // æ¸…é™¤å½“å‰ç¼–è¾‘å™¨çš„æ¿€æ´»çŠ¶æ€
        function deactivateCurrentEditor() {
            if (currentEditor) {
                try {
                    if (currentEditor.destroy) currentEditor.destroy();
                } catch (error) {
                    // å¿½ç•¥é”™è¯¯
                }
                currentEditor = null;
            }
            disableAllButtons(false);
            updateStatus('å·²åœæ­¢å½“å‰æ“ä½œ');
        }
        
        // é€šç”¨ç»˜åˆ¶å‡½æ•°
        function startDrawing(editorClass, modeName, buttonId) {
            console.log('geo', GeoTools);
            
            if (!GeoTools) {
                updateStatus('é”™è¯¯: åº“æœªåŠ è½½');
                return;
            }
            
            // æŸ¥æ‰¾ç¼–è¾‘å™¨ç±»
            const EditorClass = GeoTools[editorClass];
            
            if (!EditorClass) {
                updateStatus(`é”™è¯¯: æœªæ‰¾åˆ° ${modeName} ç¼–è¾‘å™¨ç±»`);
                log('å¯ç”¨çš„ç±»: ' + Object.keys(GeoTools).join(', '), 'error');
                return;
            }
            
            deactivateCurrentEditor();
            
            try {
                updateStatus(`å¼€å§‹ç»˜åˆ¶ ${modeName} - ${getDrawingInstructions(modeName)}`);
                
                // åˆ›å»ºæ–°çš„ç¼–è¾‘å™¨
                currentEditor = new EditorClass(map);
                features.push(currentEditor);
                activeMode = modeName;
                
                // ç›‘å¬çŠ¶æ€å˜åŒ–
                if (currentEditor.onStateChange) {
                    currentEditor.onStateChange((state) => {
                        updateStatus(`${modeName} çŠ¶æ€: ${state}`);
                        
                        if (state === GeoTools.PolygonEditorState.Idle) {
                            // ç»˜åˆ¶å®Œæˆ
                            disableAllButtons(false);
                            updateStatus(`${modeName} ç»˜åˆ¶å®Œæˆ`);
                            
                            // è·å–æ•°æ®
                            if (currentEditor.geojson) {
                                const geojson = currentEditor.geojson();
                                log(`æ–°çš„ ${modeName} æ•°æ®:`, 'success');
                                log(JSON.stringify(geojson, null, 2));
                            }
                            
                            currentEditor = null;
                            activeMode = null;
                            updateFeatureList();
                        } else if (state === GeoTools.PolygonEditorState.Drawing) {
                            // æ­£åœ¨ç»˜åˆ¶
                            disableAllButtons(true);
                        }
                    });
                }
                
                // æ›´æ–°UI
                document.getElementById(buttonId).classList.add('active');
                document.getElementById('stopDrawing').disabled = false;
                
                log(`${modeName} ç¼–è¾‘å™¨å·²åˆ›å»ºï¼Œç±»å: ${EditorClass.name}`, 'success');
                
            } catch (error) {
                updateStatus(`åˆ›å»º ${modeName} ç¼–è¾‘å™¨å¤±è´¥: ${error.message}`, 'error');
                log(`é”™è¯¯è¯¦æƒ…: ${error.stack}`, 'error');
                currentEditor = null;
                activeMode = null;
            }
        }
        
        // è·å–ç»˜åˆ¶è¯´æ˜
        function getDrawingInstructions(modeName) {
            const instructions = {
                'ç‚¹': 'ç‚¹å‡»åœ°å›¾æ·»åŠ æ ‡è®°',
                'çº¿': 'ç‚¹å‡»æ·»åŠ é¡¶ç‚¹ï¼ŒåŒå‡»ç»“æŸç»˜åˆ¶',
                'å¤šè¾¹å½¢': 'ç‚¹å‡»æ·»åŠ é¡¶ç‚¹ï¼ŒåŒå‡»ç»“æŸç»˜åˆ¶',
                'çŸ©å½¢': 'ç‚¹å‡»å¹¶æ‹–åŠ¨ç»˜åˆ¶',
                'åœ†å½¢': 'ç‚¹å‡»ç¡®å®šåœ†å¿ƒï¼Œæ‹–åŠ¨ç¡®å®šåŠå¾„'
            };
            return instructions[modeName] || 'è¯·å‚è€ƒå¯¹åº”å·¥å…·çš„ç»˜åˆ¶è¯´æ˜';
        }
        
        // æŒ‰é’®äº‹ä»¶ç»‘å®š
        document.getElementById('drawMarker').addEventListener('click', () => 
            startDrawing('MarkerPoint', 'ç‚¹', 'drawMarker'));
        
        document.getElementById('drawPolyline').addEventListener('click', () => 
            startDrawing('LeafletPolyline', 'çº¿', 'drawPolyline'));
        
        document.getElementById('drawPolygon').addEventListener('click', () => 
            startDrawing('LeafletPolygon', 'å¤šè¾¹å½¢', 'drawPolygon'));
        
        document.getElementById('drawRectangle').addEventListener('click', () => 
            startDrawing('LeafletRectangle', 'çŸ©å½¢', 'drawRectangle'));
        
        document.getElementById('drawCircle').addEventListener('click', () => 
            startDrawing('LeafletCircle', 'åœ†å½¢', 'drawCircle'));
        
        // åœæ­¢ç»˜åˆ¶
        document.getElementById('stopDrawing').addEventListener('click', deactivateCurrentEditor);
        
        // æ¸…é™¤æ‰€æœ‰
        document.getElementById('clearAll').addEventListener('click', () => {
            features.forEach(feature => {
                try {
                    if (feature.destroy) feature.destroy();
                } catch (error) {
                    // å¿½ç•¥é”™è¯¯
                }
            });
            
            features.length = 0;
            currentEditor = null;
            activeMode = null;
            
            updateStatus('å·²æ¸…é™¤æ‰€æœ‰è¦ç´ ');
            updateFeatureList();
            disableAllButtons(false);
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
            document.querySelectorAll('button.active').forEach(btn => 
                btn.classList.remove('active'));
        });
        
        // å±…ä¸­æ˜¾ç¤º
        document.getElementById('toggleView').addEventListener('click', () => {
            if (features.length > 0) {
                // è®¡ç®—æ‰€æœ‰è¦ç´ çš„è¾¹ç•Œ
                let bounds = L.latLngBounds([]);
                features.forEach(feature => {
                    if (feature.getLayer) {
                        const layer = feature.getLayer();
                        if (layer.getBounds) {
                            bounds.extend(layer.getBounds());
                        } else if (layer.getLatLng) {
                            bounds.extend(layer.getLatLng());
                        }
                    }
                });
                map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                map.setView([31.2304, 121.4737], 13);
            }
            updateStatus('åœ°å›¾å·²å±…ä¸­æ˜¾ç¤º');
        });
        
        // å¯¼å‡ºæ‰€æœ‰æ•°æ®
        document.getElementById('exportAll').addEventListener('click', () => {
            log('=== æ‰€æœ‰è¦ç´ çš„ GeoJSON æ•°æ® ===', 'info');
            
            if (features.length === 0) {
                log('æ²¡æœ‰è¦ç´ æ•°æ®', 'info');
                return;
            }
            
            const featureCollection = {
                type: "FeatureCollection",
                features: []
            };
            
            features.forEach((feature, index) => {
                if (feature.geojson) {
                    try {
                        const geojson = feature.geojson();
                        featureCollection.features.push(geojson);
                        log(`è¦ç´  ${index + 1} (${feature.constructor.name}):`, 'info');
                        log(JSON.stringify(geojson, null, 2));
                    } catch (error) {
                        log(`è·å–è¦ç´  ${index + 1} æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                    }
                } else {
                    log(`è¦ç´  ${index + 1}: æ²¡æœ‰ geojson() æ–¹æ³•`, 'error');
                }
            });
            
            // æä¾›ä¸‹è½½é“¾æ¥
            const dataStr = JSON.stringify(featureCollection, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `leaflet-geo-tools-export-${new Date().getTime()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            log(`æ•°æ®å·²å¯¼å‡ºï¼Œå…± ${features.length} ä¸ªè¦ç´ `, 'success');
        });
        

        // åˆå§‹åŒ–æ—¥å¿—
        log('Leaflet Geo Tools å®Œæ•´æ¼”ç¤ºé¡µé¢å·²åŠ è½½', 'success');
        log('åœ°å›¾ä¸­å¿ƒ: [31.2304, 121.4737] (ä¸Šæµ·)', 'info');
        log('å¯ç”¨çš„ç¼–è¾‘å™¨ç±»: ' + (GeoTools ? Object.keys(GeoTools).join(', ') : 'æ— '), 'info');
        
        // æ·»åŠ ä¸€äº›åˆå§‹åŒ–æç¤º
        setTimeout(() => {
            if (GeoTools) {
                updateStatus('å°±ç»ª - ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹ç»˜åˆ¶');
            }
        }, 1000);
    </script>
</body>
</html>