<!DOCTYPE html>
<html>
<head>
    <title>Leaflet Geo Tools - Marker æµ‹è¯•</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 500px;
            margin-top: 20px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .toolbar {
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #005fa3;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #log {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 300px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #e6f7ff;
            border-left: 4px solid #007acc;
            border-radius: 4px;
        }
        .marker-list {
            margin-top: 10px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
        }
        .marker-item {
            padding: 5px;
            margin: 2px 0;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Leaflet Geo Tools - Marker æµ‹è¯•</h1>
    
    <div class="status" id="status">çŠ¶æ€: å‡†å¤‡å°±ç»ª</div>
    
    <div class="toolbar">
        <h3>Marker æµ‹è¯•</h3>
        <button id="drawMarker">ğŸ“ å¼€å§‹ç»˜åˆ¶ Marker</button>
        <button id="stopDrawing" disabled>ğŸ›‘ åœæ­¢ç»˜åˆ¶</button>
        <button id="clearAll">ğŸ§¹ æ¸…é™¤æ‰€æœ‰ Marker</button>
        <button id="exportMarkers">ğŸ“‹ å¯¼å‡ºæ‰€æœ‰ Marker</button>
    </div>
    
    <div id="map"></div>
    
    <div class="toolbar">
        <h4>å·²åˆ›å»ºçš„ Marker åˆ—è¡¨</h4>
        <div id="markerList" class="marker-list"></div>
    </div>
    
    <div id="log"></div>
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@7/turf.min.js"></script>
    
    <!-- ä½ çš„åº“ -->
    <!-- æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„å®é™…æ„å»ºç»“æœè°ƒæ•´è·¯å¾„ -->
    <script src="../../dist/index.js"></script>

    
    <script>
        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½æˆåŠŸ
        console.log('æ£€æŸ¥å…¨å±€å˜é‡:', window.LeafletGeoTools);
        
        // è·å–åº“çš„å¼•ç”¨
        const GeoTools = window.LeafletGeoTools;
        
        if (!GeoTools) {
            alert('é”™è¯¯: LeafletGeoTools åº“æœªåŠ è½½æˆåŠŸï¼è¯·æ£€æŸ¥ï¼š\n1. æ˜¯å¦æ­£ç¡®æ„å»ºäº† dist/index.js\n2. è·¯å¾„æ˜¯å¦æ­£ç¡®\n3. æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯ä¿¡æ¯');
            console.error('å¯ç”¨çš„å…¨å±€å˜é‡:', Object.keys(window));
        } else {
            console.log('åº“åŠ è½½æˆåŠŸï¼å¯ç”¨çš„ç±»:', Object.keys(GeoTools));
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        const map = L.map('map').setView([31.2304, 121.4737], 13); // ä¸Šæµ·åæ ‡
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // çŠ¶æ€è·Ÿè¸ª
        let currentEditor = null;
        const markers = []; // å­˜å‚¨æ‰€æœ‰åˆ›å»ºçš„ marker å®ä¾‹
        
        // DOM å…ƒç´ 
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const markerListEl = document.getElementById('markerList');
        
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(message) {
            statusEl.textContent = `çŠ¶æ€: ${message}`;
            log(message);
        }
        
        // æ›´æ–° marker åˆ—è¡¨æ˜¾ç¤º
        function updateMarkerList() {
            markerListEl.innerHTML = '';
            markers.forEach((marker, index) => {
                const item = document.createElement('div');
                item.className = 'marker-item';
                item.innerHTML = `
                    Marker ${index + 1} 
                    <button onclick="removeMarker(${index})" style="padding:2px 8px;margin-left:10px;font-size:10px;">åˆ é™¤</button>
                    <button onclick="viewMarker(${index})" style="padding:2px 8px;margin-left:5px;font-size:10px;">æŸ¥çœ‹</button>
                `;
                markerListEl.appendChild(item);
            });
        }
        
        // åˆ é™¤ marker
        window.removeMarker = function(index) {
            if (markers[index]) {
                try {
                    if (markers[index].destroy) markers[index].destroy();
                    else if (markers[index].remove) markers[index].remove();
                    markers.splice(index, 1);
                    updateStatus(`å·²åˆ é™¤ Marker ${index + 1}`);
                    updateMarkerList();
                } catch (error) {
                    updateStatus(`åˆ é™¤å¤±è´¥: ${error.message}`);
                }
            }
        };
        
        // æŸ¥çœ‹ marker
        window.viewMarker = function(index) {
            if (markers[index] && markers[index].geojson) {
                try {
                    const geojson = markers[index].geojson();
                    log(`Marker ${index + 1} çš„åæ ‡: ${JSON.stringify(geojson)}`);
                    map.setView([geojson.geometry.coordinates[1], geojson.geometry.coordinates[0]], 15);
                } catch (error) {
                    updateStatus(`è·å–åæ ‡å¤±è´¥: ${error.message}`);
                }
            }
        };
        
        // ç»˜åˆ¶ Marker æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('drawMarker').addEventListener('click', function() {
            if (!GeoTools) {
                updateStatus('é”™è¯¯: åº“æœªåŠ è½½');
                return;
            }
            
            // å°è¯•ä¸åŒçš„ç±»å
            const MarkerClass = GeoTools.LeafletMarkerEditor || 
                               GeoTools.MarkerPointEditor || 
                               GeoTools.MarkerPoint ||
                               GeoTools.default?.LeafletMarkerEditor;
            
            if (!MarkerClass) {
                updateStatus('é”™è¯¯: æœªæ‰¾åˆ° Marker ç¼–è¾‘å™¨ç±»');
                log('å¯ç”¨çš„ç±»: ' + Object.keys(GeoTools).join(', '));
                return;
            }
            
            // æ¸…ç†å½“å‰çš„ç¼–è¾‘å™¨
            if (currentEditor) {
                try {
                    if (currentEditor.exitEditMode) currentEditor.exitEditMode();
                    if (currentEditor.destroy) currentEditor.destroy();
                } catch (error) {
                    // å¿½ç•¥é”™è¯¯
                }
            }
            
            try {
                updateStatus('å¼€å§‹ç»˜åˆ¶ Marker - è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»æ·»åŠ æ ‡è®°');
                
                // åˆ›å»ºæ–°çš„ Marker ç¼–è¾‘å™¨
                currentEditor = new MarkerClass(map);
                markers.push(currentEditor);
                
                // ç›‘å¬çŠ¶æ€å˜åŒ–
                if (currentEditor.onStateChange) {
                    currentEditor.onStateChange((state) => {
                        updateStatus(`Marker çŠ¶æ€: ${state}`);
                        
                        if (state === 'idle' || state === 'Idle') {
                            // ç»˜åˆ¶å®Œæˆ
                            document.getElementById('stopDrawing').disabled = true;
                            document.getElementById('drawMarker').disabled = false;
                            updateStatus('Marker ç»˜åˆ¶å®Œæˆ');
                            
                            // è·å–åæ ‡
                            if (currentEditor.geojson) {
                                const geojson = currentEditor.geojson();
                                log(`æ–°çš„ Marker åæ ‡: ${JSON.stringify(geojson.geometry.coordinates)}`);
                            }
                            
                            currentEditor = null;
                            updateMarkerList();
                        } else if (state === 'drawing' || state === 'Drawing') {
                            // æ­£åœ¨ç»˜åˆ¶
                            document.getElementById('stopDrawing').disabled = false;
                            document.getElementById('drawMarker').disabled = true;
                        }
                    });
                }
                
                // æ›´æ–° UI
                document.getElementById('stopDrawing').disabled = false;
                document.getElementById('drawMarker').disabled = true;
                
                log(`Marker ç¼–è¾‘å™¨å·²åˆ›å»ºï¼Œç±»å: ${MarkerClass.name}`);
                
            } catch (error) {
                updateStatus(`åˆ›å»º Marker ç¼–è¾‘å™¨å¤±è´¥: ${error.message}`);
                log(`é”™è¯¯è¯¦æƒ…: ${error.stack}`);
                currentEditor = null;
            }
        });
        
        // åœæ­¢ç»˜åˆ¶
        document.getElementById('stopDrawing').addEventListener('click', function() {
            if (currentEditor) {
                try {
                    if (currentEditor.exitEditMode) currentEditor.exitEditMode();
                    if (currentEditor.destroy) currentEditor.destroy();
                    updateStatus('å·²åœæ­¢ç»˜åˆ¶');
                } catch (error) {
                    updateStatus(`åœæ­¢ç»˜åˆ¶å¤±è´¥: ${error.message}`);
                }
                currentEditor = null;
            }
            
            document.getElementById('stopDrawing').disabled = true;
            document.getElementById('drawMarker').disabled = false;
        });
        
        // æ¸…é™¤æ‰€æœ‰
        document.getElementById('clearAll').addEventListener('click', function() {
            markers.forEach(marker => {
                try {
                    if (marker.destroy) marker.destroy();
                    else if (marker.remove) marker.remove();
                } catch (error) {
                    // å¿½ç•¥é”™è¯¯
                }
            });
            
            markers.length = 0;
            currentEditor = null;
            
            updateStatus('å·²æ¸…é™¤æ‰€æœ‰ Marker');
            updateMarkerList();
            document.getElementById('stopDrawing').disabled = true;
            document.getElementById('drawMarker').disabled = false;
        });
        
        // å¯¼å‡ºæ‰€æœ‰ Marker
        document.getElementById('exportMarkers').addEventListener('click', function() {
            log('=== æ‰€æœ‰ Marker çš„ GeoJSON æ•°æ® ===');
            
            if (markers.length === 0) {
                log('æ²¡æœ‰ Marker æ•°æ®');
                return;
            }
            
            markers.forEach((marker, index) => {
                if (marker.geojson) {
                    try {
                        const geojson = marker.geojson();
                        log(`Marker ${index + 1}:`);
                        log(JSON.stringify(geojson, null, 2));
                    } catch (error) {
                        log(`è·å– Marker ${index + 1} æ•°æ®å¤±è´¥: ${error.message}`);
                    }
                } else {
                    log(`Marker ${index + 1}: æ²¡æœ‰ geojson() æ–¹æ³•`);
                }
            });
        });
        
        // åˆå§‹åŒ–æ—¥å¿—
        log('Leaflet Geo Tools Marker æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('åœ°å›¾ä¸­å¿ƒ: [31.2304, 121.4737] (ä¸Šæµ·)');
        log('ç­‰å¾…ç”¨æˆ·æ“ä½œ...');
        
        // æ·»åŠ ä¸€äº›æµ‹è¯• Marker
        setTimeout(() => {
            if (GeoTools) {
                log('åº“å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
                updateStatus('å°±ç»ª - ç‚¹å‡»"å¼€å§‹ç»˜åˆ¶ Marker"æŒ‰é’®å¼€å§‹æµ‹è¯•');
            }
        }, 1000);
    </script>
</body>
</html>